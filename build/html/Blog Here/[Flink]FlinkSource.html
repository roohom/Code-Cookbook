<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>6. [Flink]Flink Sources &mdash; Code-Cookbook 0.2 文档</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/translations.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="7. [Flink]ProcessFunction无法使用，抛出InvalidProgramException" href="%5BFlink%5DProcessFunction%E6%97%A0%E6%B3%95%E4%BD%BF%E7%94%A8%EF%BC%8C%E6%8A%9B%E5%87%BAInvalidProgramException.html" />
    <link rel="prev" title="5. [Flink]Flink-connector-http" href="%5BFlink%5DFlink-connector-http.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Code-Cookbook
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">大数据</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Bigdata/index.html">Bigdata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Bigdata%20Tools/index.html">Bigdata Tools</a></li>
</ul>
<p class="caption"><span class="caption-text">博客</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Blogs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Boxed%20Error.html">1. [Springboot x spark]java.util.concurrent.ExecutionException: Boxed Error</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BApollo%5DApollo%20Config%20Center.html">2. [Apollo]Apollo Config Center</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BConfluent%5DConfluent.html">3. [Confluent]Confluent快速上手</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BFlink%5DCommdLine%2BSpringboot%2Bflink%E6%97%A0%E6%B3%95%E6%8C%87%E5%AE%9A%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%90%AF%E5%8A%A8.html">4. [Flink]CommdLine+Springboot+flink无法指定配置文件启动</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BFlink%5DFlink-connector-http.html">5. [Flink]Flink-connector-http</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">6. [Flink]Flink Sources</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#hive">6.1. Hive</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#read-from-hive">6.1.1. Read From Hive</a></li>
<li class="toctree-l4"><a class="reference internal" href="#write-to-hive">6.1.2. Write To Hive</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#kafka">6.2. Kafka</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#read-from-kafka">6.2.1. Read From Kafka</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sink-to-kafka">6.2.2. Sink to kafka</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#http">6.3. HTTP</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="%5BFlink%5DProcessFunction%E6%97%A0%E6%B3%95%E4%BD%BF%E7%94%A8%EF%BC%8C%E6%8A%9B%E5%87%BAInvalidProgramException.html">7. [Flink]ProcessFunction无法使用，抛出InvalidProgramException</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BFlink%5D%E4%BD%BF%E7%94%A8%E7%8A%B6%E6%80%81%E7%AE%97%E5%AD%90%E5%B0%86stream%E8%81%9A%E5%90%88%E8%BE%93%E5%87%BA.html">8. [Flink]使用状态算子将stream聚合输出</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BFlink%5D%E5%A6%82%E4%BD%95%E6%9B%B4%E9%80%9A%E7%94%A8%E5%9C%B0%E5%B0%86Kafka%28%E6%88%96%E5%85%B6%E4%BB%96%29%E6%95%B0%E6%8D%AE%E8%90%BD%E5%9C%B0Hive%EF%BC%9F.html">9. [Flink]如何更通用地将Kafka(或其他)数据落地Hive？</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BFlink%5D%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BA%8F%E5%88%97%E5%8C%96%E6%B6%88%E8%B4%B9Kafka%E6%95%B0%E6%8D%AE.html">10. [Flink]自定义序列化消费Kafka数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BGit%5DGit.html">11. [Git]Git问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BGit%5D%E8%AF%AF%E5%9C%A8Master%E5%88%86%E6%94%AF%E5%BC%80%E5%8F%91%E5%B9%B6commit%E6%97%A0%E6%B3%95push.html">12. [Git]误在Master分支开发并commit无法push</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BHadoop%5DHadoop%20distcp.html">13. [Hadoop]Hadoop distcp</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BHadoop%5D%E4%B8%80%E4%BA%9BHadoop%E9%97%AE%E9%A2%98.html">14. [Hadoop]一些Hadoop问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BHive%5DHive%E5%88%86%E5%8C%BA%E8%A1%A8%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4%E5%88%86%E5%8C%BA.html">15. [Hive]Hive分区表批量删除分区</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BHive%5D%E5%9C%A8%E6%8C%87%E5%AE%9A%E4%BD%8D%E7%BD%AE%E6%B7%BB%E5%8A%A0%E5%AD%97%E6%AE%B5.html">16. [Hive]在指定位置添加字段</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BHive%5D%E5%A4%96%E9%83%A8%E8%A1%A8%E4%BF%AE%E6%94%B9%E4%B8%BA%E5%86%85%E9%83%A8%E8%A1%A8.html">17. [Hive]外部表修改为内部表</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BHive%5D%E6%9C%AC%E5%9C%B0%E8%BF%9E%E6%8E%A5%E9%9C%80%E8%A6%81Kerberos%E8%AE%A4%E8%AF%81%E7%9A%84Hive.html">18. [Hive]本地连接需要Kerberos认证的Hive</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BJAVA%5DJava%20Cookbook.html">19. [JAVA]JAVA Cookbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BJava%5DAnnotation.html">20. [Java]元注解</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BJava%5DAnnotation.html#id1">21. 注解解析</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BJava%5DCollection.html">22. [Java]集合</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BJava%5DCollection.html#id8">23. 简单(常用)数据结构</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BJava%5DIO%E6%B5%81.html">24. [Java]<code class="docutils literal notranslate"><span class="pre">IO</span> <span class="pre">Stream</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BJava%5DJava8%20Stream.html">25. [Java]Java8 Stream API</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BJava%5DOOP.html">26. [Java]Java_OOP</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BJava%5DSocket.html">27. [Java]Socket</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BJava%5DSocket%E5%8F%91%E9%80%81%E6%96%87%E4%BB%B6%E8%87%B3%E6%9C%8D%E5%8A%A1%E7%AB%AF.html">28. [Java]使用Java在服务端和客户端之间传送文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BJava%5D%E4%B8%89%E7%A7%8D%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%E5%BA%94%E7%94%A8%E4%BA%8E%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%90%AF%E5%8A%A8.html">29. [Java]三种策略模式应用于服务的启动</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BJava%5D%E5%A4%9A%E7%BA%BF%E7%A8%8B.html">30. [Java]多线程</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BJava%5D%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9E%8B%E9%97%AE%E9%A2%98.html">31. [Java]生产者消费者模型问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BJava%5D%E8%AE%A9%E9%A1%B9%E7%9B%AE%E9%A1%BA%E5%88%A9%E8%AF%BB%E5%8F%96resources%E7%9B%AE%E5%BD%95%E4%B8%8B%E7%9A%84%E6%96%87%E4%BB%B6.html">32. [Java]让项目顺利读取resources目录下的文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BJava%5D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html">33. [Java]设计模式</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BJava%5D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html#continuing">34. Continuing…</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BJava%5D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%85%AD%E5%A4%A7%E5%8E%9F%E5%88%99.html">35. [Java]设计模式六大原则</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BJava%5D%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E6%A2%B3%E7%90%86.html">36. [Java]面向对象知识点梳理</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BJava%5D%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%90%84%E7%A7%8D%E5%85%B3%E7%B3%BB.html">37. [Java]OOP防脱发指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BKerberos%5DMessage%20stream%20modified%20%2841%29%E9%94%99%E8%AF%AF.html">38. [Kerberos]Message stream modified (41)错误</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BKudu%5D%E5%85%B3%E4%BA%8EKudu%20Upsert%E5%88%97%E7%9A%84%E9%97%AE%E9%A2%98.html">39. [Kudu]关于Kudu Upsert列的问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BKudu%5D%E5%85%B3%E4%BA%8EKudu%E5%88%97%E7%9A%84%E9%A1%BA%E5%BA%8F%E7%9A%84%E4%BF%AE%E6%94%B9.html">40. [Kudu]关于Kudu列的顺序的修改</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BMongoDB%5DMongoDB%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2.html">41. [MongoDB]MongoDB基本查询</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BPySpark%5DPySpark.html">42. [Pyspark]PySpark</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BPySpark%5DPySparkOnYarn.html">43. [PySpark]PySpark On Yarn</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BSQL%5DSQLIn%26NotIn.html">44. [SQL]<code class="docutils literal notranslate"><span class="pre">IN</span></code> OR <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">IN</span></code> , IS A PROBLEM</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BSQL%5D%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%60create_time%60%E5%92%8C%60update_time%60.html">45. [SQL]业务数据库中的<code class="docutils literal notranslate"><span class="pre">create_time</span></code>和<code class="docutils literal notranslate"><span class="pre">update_time</span></code>分析时的问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BSQL%5D%E4%B8%BA%E4%BB%80%E4%B9%88LEFT%20JOIN%E5%90%8E%E6%80%BB%E6%95%B0%E5%8D%B4%E4%B8%8E%E5%8F%B3%E8%A1%A8%E7%9A%84%E6%80%BB%E6%95%B0%E4%B8%80%E6%A0%B7%E4%BA%86%EF%BC%9F.html">46. [SQL]为什么LEFT JOIN后总数却与右表的总数一样了？</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BSQL%5D%E6%B1%82%E7%94%A8%E6%88%B7%E4%BB%BB%E6%84%8F%E5%A4%A9%E8%BF%9E%E7%BB%AD%E7%99%BB%E5%BD%95%28%E6%AF%8F%E5%A4%A9%E4%B8%BA%E7%AC%AC%E5%A4%9A%E5%B0%91%E5%A4%A9%E8%BF%9E%E7%BB%AD%E7%99%BB%E5%BD%95%29.html">47. [SQL]求用户任意天连续登录(每天为第多少天连续登录)</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BSQL%5D%E8%AE%A1%E7%AE%97%E6%8C%87%E5%AE%9A%E6%97%A5%E6%9C%9F%E7%9A%84%E5%B9%B4-%E5%91%A8%28%E4%B8%BA%E6%9F%90%E5%B9%B4%E7%9A%84%E7%AC%AC%E5%A4%9A%E5%B0%91%E5%91%A8%29.html">48. [SQL]计算指定日期的<strong>年-周</strong>(为某年的第多少周)</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BScala%5DClosure%26Currying.html">49. [Scala]函数中闭包(Closure)和柯里化(Currying)</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BShell%5DEOF.html">50. [Shell]EOF</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BShell%5Dshell%E8%84%9A%E6%9C%AC%E6%97%A5%E6%9C%9F%E9%80%92%E5%A2%9E%28%E8%B5%B7%E6%AD%A2%E6%97%A5%E6%9C%9F%E5%86%85%E9%80%92%E5%A2%9E%29.html">51. [Shell]Shell脚本日期递增(起止日期内递增)</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BShell%5D%E6%89%93%E5%8D%B0%E6%9C%AC%E6%9C%BAIP.html">52. [Shell]打印本机IP</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BSparkStreaming%5D%E6%B6%88%E8%B4%B9kafka%E5%86%99%E5%85%A5Hive%E5%A4%B1%E8%B4%A5%E7%9A%84%E9%97%AE%E9%A2%98.html">53. [SparkStreaming]消费kafka写入Hive失败的问题Lease timeout of 0 seconds expired</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BSpark%5DSparkSQL%20%E5%88%97%E8%BD%AC%E8%A1%8C%E7%9A%84%E4%B8%80%E7%A7%8D%E6%96%B9%E6%B3%95.html">54. [Spark]SparkSQL 列转行的一种方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BSpark%5DSparkSQLJDBC%E5%B9%B6%E5%8F%91%E8%BF%9E%E6%8E%A5%E8%AF%BB%E5%8F%96.html">55. [Spark]SparkSQL JDBC并发连接读取</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BSpark%5DSpark%E6%8F%90%E4%BA%A4%E4%BB%BB%E5%8A%A1RSA%20premaster%20secret%20error.html">56. [Spark]Spark提交任务RSA premaster secret error</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BSpark%5DSpringboot%E6%95%B4%E5%90%88Spark%2C%20%E6%9C%AC%E5%9C%B0%E3%80%81%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2.html">57. [Spark]Springboot整合Spark, 本地、集群部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BSpark%5D%E4%BD%BF%E7%94%A8Java%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AARow.html">58. [Spark]如何使用Java创建一个Row</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BSpark%5D%E5%B0%86Spark%20DataFrame%E4%B8%AD%E7%9A%84%E6%95%B0%E5%80%BC%E5%8F%96%E5%87%BA.html">59. [Spark]将Spark DataFrame中的数值取出</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BSpringboot%5DokHttp%E9%94%99%E8%AF%AFException%20in%20thread%20OkHttp%20Dispatcher%20java.lang.IllegalStateException%20closed.html">60. [Springboot]okHttp错误:<em>Exception</em> in thread “OkHttp Dispatcher” <em>java.lang.IllegalStateException</em>: closed</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5BVim%5D%E6%9F%A5%E6%89%BE%E5%92%8C%E6%9B%BF%E6%8D%A2%E5%91%BD%E4%BB%A4.html">61. [Vim]Vim查找和替换命令</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5Bdebezium%5D%E5%9C%A8%E5%90%AF%E5%8A%A8%E4%BB%BB%E5%8A%A1%E6%97%B6%E4%BC%A0%E5%85%A5SQL%E8%AF%AD%E5%8F%A5%E7%94%9F%E6%88%90Snapshot.html">62. [debezium]在启动任务时传入SQL语句生成Snapshot</a></li>
<li class="toctree-l2"><a class="reference internal" href="%5Bdebezium%5D%E7%83%AD%E4%BF%AE%E6%94%B9DebeziumMySQLConnector%E9%85%8D%E7%BD%AE.html">63. [debezium]热修改Debezium MySQL Connector配置</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">大数据辅助工具</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Auxiliary%20tools/index.html">Auxiliary tools</a></li>
</ul>
<p class="caption"><span class="caption-text">SQL相关</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../SQL/index.html">SQL</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Code-Cookbook</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Blogs</a> &raquo;</li>
      <li><span class="section-number">6. </span>[Flink]Flink Sources</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/Blog Here/[Flink]FlinkSource.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="flink-flink-sources">
<h1><span class="section-number">6. </span>[Flink]Flink Sources<a class="headerlink" href="#flink-flink-sources" title="永久链接至标题"></a></h1>
<blockquote>
<div><p>本文在下面记录了一些常用的Flink读取常见的数据源的方法，虽然在官网已经有详细的说明文档了，但是只看文档还是不行的，还得实际操练起来，毕竟代码只有写多了才会用，遇到的bug越多，经验也就越多。</p>
</div></blockquote>
<p>先说明，Flink官网已经明确表示，DatasetAPI将在今后的版本中被删除，目前为软删除状态，强烈建议大家使用TableAndSQL API 或者DataStreamAPI批模式</p>
<blockquote>
<div><p>Starting with Flink 1.12 the DataSet API has been soft deprecated.</p>
<p>We recommend that you use the <a class="reference external" href="https://ci.apache.org/projects/flink/flink-docs-release-1.13/docs/dev/table/overview/">Table API and SQL</a> to run efficient batch pipelines in a fully unified API. Table API is well integrated with common batch connectors and catalogs.</p>
<p>Alternatively, you can also use the DataStream API with <code class="docutils literal notranslate"><span class="pre">BATCH</span></code> <a class="reference external" href="https://ci.apache.org/projects/flink/flink-docs-release-1.13/docs/dev/datastream/execution_mode/">execution mode</a>. The linked section also outlines cases where it makes sense to use the DataSet API but those cases will become rarer as development progresses and the DataSet API will eventually be removed. Please also see <a class="reference external" href="https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=158866741">FLIP-131</a> for background information on this decision.</p>
</div></blockquote>
<section id="hive">
<h2><span class="section-number">6.1. </span>Hive<a class="headerlink" href="#hive" title="永久链接至标题"></a></h2>
<p>如今，Hive仍然是数据仓库构建的主要工具（这话说得好别扭），就是说，只要是在做数仓，你一定会接触到Hive，那么使用Flink读取或者写入到Hive就显得很有必要。</p>
<section id="read-from-hive">
<h3><span class="section-number">6.1.1. </span>Read From Hive<a class="headerlink" href="#read-from-hive" title="永久链接至标题"></a></h3>
<p>虽然使用HiveCatalog连接到Hive不需要规划器，但是读写Hive都需要使用BlinkPlanner</p>
<blockquote>
<div><p>Please note while HiveCatalog doesn’t require a particular planner, reading/writing Hive tables only works with blink planner. Therefore it’s highly recommended that you use blink planner when connecting to your Hive warehouse.</p>
</div></blockquote>
<p>以下为读写Hive的一个实例：读支持了流的模式也支持批的模式，以下使用了流的模式，读可以，但是写不太好使，如果想写，可以使用批模式，在下面有说。</p>
<blockquote>
<div><p>Note:本地运行，所以需要在resources目录下放置集群的四个<code class="docutils literal notranslate"><span class="pre">site.xml</span></code></p>
</div></blockquote>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HiveSource</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">HIVE_CATALOG</span> <span class="o">=</span> <span class="s">&quot;default&quot;</span><span class="p">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//定义流处理环境</span>
        <span class="n">StreamExecutionEnvironment</span> <span class="n">streamEnv</span> <span class="o">=</span> <span class="n">StreamExecutionEnvironment</span><span class="p">.</span><span class="na">getExecutionEnvironment</span><span class="p">();</span>
        <span class="n">EnvironmentSettings</span> <span class="n">streamSetting</span> <span class="o">=</span> <span class="n">EnvironmentSettings</span><span class="p">.</span><span class="na">newInstance</span><span class="p">().</span><span class="na">useBlinkPlanner</span><span class="p">().</span><span class="na">inStreamingMode</span><span class="p">().</span><span class="na">build</span><span class="p">();</span>
        <span class="n">StreamTableEnvironment</span> <span class="n">tEnv</span> <span class="o">=</span> <span class="n">StreamTableEnvironment</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">streamEnv</span><span class="p">,</span> <span class="n">streamSetting</span><span class="p">);</span>

        <span class="n">HiveCatalog</span> <span class="n">hive</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HiveCatalog</span><span class="p">(</span><span class="n">HIVE_CATALOG</span><span class="p">,</span> <span class="s">&quot;test&quot;</span><span class="p">,</span> <span class="s">&quot;lib/conf&quot;</span><span class="p">);</span>
        <span class="n">tEnv</span><span class="p">.</span><span class="na">registerCatalog</span><span class="p">(</span><span class="n">HIVE_CATALOG</span><span class="p">,</span> <span class="n">hive</span><span class="p">);</span>
        <span class="n">tEnv</span><span class="p">.</span><span class="na">useCatalog</span><span class="p">(</span><span class="n">HIVE_CATALOG</span><span class="p">);</span>
        <span class="n">tEnv</span><span class="p">.</span><span class="na">useDatabase</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">);</span>
        <span class="n">tEnv</span><span class="p">.</span><span class="na">executeSql</span><span class="p">(</span><span class="s">&quot;SHOW DATABASES&quot;</span><span class="p">).</span><span class="na">print</span><span class="p">();</span>
        
        <span class="n">tEnv</span><span class="p">.</span><span class="na">executeSql</span><span class="p">(</span><span class="s">&quot;SELECT * FROM ods_user&quot;</span><span class="p">).</span><span class="na">print</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>结果：</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>+---------------+
| database name |
+---------------+
|       default |
|   dw_unicdata |
|          test |
|      unicdata |
+---------------+
4 rows in set
+-------------+--------------------------------+--------------------------------+
|          id |                           name |                             dt |
+-------------+--------------------------------+--------------------------------+
|           1 |                         长大强 |                     2021-07-24 |
|           2 |                         孙大壮 |                     2021-07-24 |
+-------------+--------------------------------+--------------------------------+
2 rows in set
</pre></div>
</div>
</section>
<section id="write-to-hive">
<h3><span class="section-number">6.1.2. </span>Write To Hive<a class="headerlink" href="#write-to-hive" title="永久链接至标题"></a></h3>
<section id="batch-mode">
<h4><span class="section-number">6.1.2.1. </span>批模式(Batch Mode)<a class="headerlink" href="#batch-mode" title="永久链接至标题"></a></h4>
<p>和读的方式类似，写入，以下使用<strong>批模式</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HiveSource</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">HIVE_CATALOG</span> <span class="o">=</span> <span class="s">&quot;default&quot;</span><span class="p">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//定义流处理环境</span>
<span class="c1">//        ExecutionEnvironment streamEnv = ExecutionEnvironment.getExecutionEnvironment();</span>
        <span class="n">EnvironmentSettings</span> <span class="n">streamSetting</span> <span class="o">=</span> <span class="n">EnvironmentSettings</span><span class="p">.</span><span class="na">newInstance</span><span class="p">().</span><span class="na">useBlinkPlanner</span><span class="p">().</span><span class="na">inBatchMode</span><span class="p">().</span><span class="na">build</span><span class="p">();</span>
        <span class="n">TableEnvironment</span> <span class="n">tEnv</span> <span class="o">=</span> <span class="n">TableEnvironment</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">streamSetting</span><span class="p">);</span>

        <span class="n">HiveCatalog</span> <span class="n">hive</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HiveCatalog</span><span class="p">(</span><span class="n">HIVE_CATALOG</span><span class="p">,</span> <span class="s">&quot;test&quot;</span><span class="p">,</span> <span class="s">&quot;lib/conf&quot;</span><span class="p">);</span>
        <span class="n">tEnv</span><span class="p">.</span><span class="na">registerCatalog</span><span class="p">(</span><span class="n">HIVE_CATALOG</span><span class="p">,</span> <span class="n">hive</span><span class="p">);</span>
        <span class="n">tEnv</span><span class="p">.</span><span class="na">useCatalog</span><span class="p">(</span><span class="n">HIVE_CATALOG</span><span class="p">);</span>
        <span class="n">tEnv</span><span class="p">.</span><span class="na">useDatabase</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">);</span>
        <span class="n">tEnv</span><span class="p">.</span><span class="na">executeSql</span><span class="p">(</span><span class="s">&quot;SHOW DATABASES&quot;</span><span class="p">).</span><span class="na">print</span><span class="p">();</span>

        <span class="n">tEnv</span><span class="p">.</span><span class="na">executeSql</span><span class="p">(</span><span class="s">&quot;SELECT * FROM ods_user&quot;</span><span class="p">).</span><span class="na">print</span><span class="p">();</span>
        <span class="n">tEnv</span><span class="p">.</span><span class="na">executeSql</span><span class="p">(</span><span class="s">&quot;INSERT INTO test.ods_user PARTITION(dt=&#39;2021-08-19&#39;) SELECT id, name FROM test.ods_user&quot;</span><span class="p">).</span><span class="na">print</span><span class="p">();</span>
        <span class="n">tEnv</span><span class="p">.</span><span class="na">executeSql</span><span class="p">(</span><span class="s">&quot;SELECT * FROM ods_user&quot;</span><span class="p">).</span><span class="na">print</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>结果：</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>+-----------------------+
| default.test.ods_user |
+-----------------------+
|                    -1 |
+-----------------------+
1 row in set
+-------------+--------------------------------+--------------------------------+
|          id |                           name |                             dt |
+-------------+--------------------------------+--------------------------------+
|           1 |                         长大强 |                     2021-08-19 |
|           2 |                         孙大壮 |                     2021-08-19 |
|           2 |                         孙大壮 |                     2021-08-19 |
|           1 |                         长大强 |                     2021-07-24 |
|           2 |                         孙大壮 |                     2021-07-24 |
|           1 |                         长大强 |                     2021-08-19 |
|           2 |                         孙大壮 |                     2021-08-19 |
|           1 |                         长大强 |                     2021-08-19 |
+-------------+--------------------------------+--------------------------------+
8 rows in set
</pre></div>
</div>
</section>
<section id="streaming-mode">
<h4><span class="section-number">6.1.2.2. </span>流表模式(Streaming Mode)<a class="headerlink" href="#streaming-mode" title="永久链接至标题"></a></h4>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">StreamExecutionEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="n">StreamExecutionEnvironment</span><span class="p">.</span><span class="na">getExecutionEnvironment</span><span class="p">();</span>
<span class="c1">//CHECKPOINT</span>
<span class="n">env</span><span class="p">.</span><span class="na">enableCheckpointing</span><span class="p">(</span><span class="mi">6000</span><span class="p">);</span>
<span class="n">env</span><span class="p">.</span><span class="na">getCheckpointConfig</span><span class="p">().</span><span class="na">setCheckpointingMode</span><span class="p">(</span><span class="n">CheckpointingMode</span><span class="p">.</span><span class="na">EXACTLY_ONCE</span><span class="p">);</span>
<span class="n">env</span><span class="p">.</span><span class="na">getCheckpointConfig</span><span class="p">().</span><span class="na">setCheckpointTimeout</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
<span class="n">env</span><span class="p">.</span><span class="na">getCheckpointConfig</span><span class="p">().</span><span class="na">setTolerableCheckpointFailureNumber</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="c1">//RESTART STRATEGY</span>
<span class="n">env</span><span class="p">.</span><span class="na">setRestartStrategy</span><span class="p">(</span><span class="n">RestartStrategies</span><span class="p">.</span><span class="na">fixedDelayRestart</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
      <span class="n">Time</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">)));</span>

<span class="n">DataStreamSource</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">streamSource</span> <span class="o">=</span> <span class="n">env</span><span class="p">.</span><span class="na">readTextFile</span><span class="p">(</span><span class="s">&quot;a text file to generate source records&quot;</span><span class="p">);</span>
<span class="n">EnvironmentSettings</span> <span class="n">streamSetting</span> <span class="o">=</span> <span class="n">EnvironmentSettings</span><span class="p">.</span><span class="na">newInstance</span><span class="p">().</span><span class="na">useBlinkPlanner</span><span class="p">().</span><span class="na">inStreamingMode</span><span class="p">().</span><span class="na">build</span><span class="p">();</span>
<span class="n">StreamTableEnvironment</span> <span class="n">streamTableEnv</span> <span class="o">=</span> <span class="n">StreamTableEnvironment</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">streamSetting</span><span class="p">);</span>
<span class="c1">//设置hive catalog</span>
<span class="n">HiveCatalog</span> <span class="n">hive</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HiveCatalog</span><span class="p">(</span><span class="n">flinkSinkHiveProperties</span><span class="p">.</span><span class="na">getCatalog</span><span class="p">(),</span>
        <span class="s">&quot;a database to use&quot;</span><span class="p">,</span>
        <span class="s">&quot;hive conf dir(在cdh上一般为/etc/hive/conf)&quot;</span>
<span class="p">);</span>
<span class="n">streamTableEnv</span><span class="p">.</span><span class="na">registerCatalog</span><span class="p">(</span><span class="s">&quot;catalog名(自定义)&quot;</span><span class="p">,</span> <span class="n">hive</span><span class="p">);</span>
<span class="n">streamTableEnv</span><span class="p">.</span><span class="na">useCatalog</span><span class="p">(</span><span class="s">&quot;catalog名(自定义)&quot;</span><span class="p">);</span>
<span class="n">streamTableEnv</span><span class="p">.</span><span class="na">useDatabase</span><span class="p">(</span><span class="s">&quot;数据库名，自己指定&quot;</span><span class="p">);</span>
<span class="n">streamTableEnv</span><span class="p">.</span><span class="na">getConfig</span><span class="p">().</span><span class="na">getConfiguration</span><span class="p">().</span><span class="na">setString</span><span class="p">(</span><span class="s">&quot;table.exec.hive.fallback-mapred-reader&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">);</span>

<span class="c1">//--------------------------------------------------------------------------------------------------------</span>
<span class="c1">//  执行hive语句</span>
<span class="c1">//--------------------------------------------------------------------------------------------------------</span>
<span class="c1">//1、可以使用 StatementSet ，往StatementSet中添加语句然后批量执行，</span>
<span class="n">StatementSet</span> <span class="n">hiveStatementSet</span> <span class="o">=</span> <span class="n">streamTableEnv</span><span class="p">.</span><span class="na">createStatementSet</span><span class="p">();</span>
<span class="n">hiveStatementSet</span><span class="p">.</span><span class="na">addInsertSql</span><span class="p">(</span><span class="n">sql</span><span class="p">);</span>
<span class="n">hiveStatementSet</span><span class="p">.</span><span class="na">execute</span><span class="p">();</span>

<span class="c1">//2、也可以使用</span>
<span class="n">streamTableEnv</span><span class="p">.</span><span class="na">executeSql</span><span class="p">(</span><span class="s">&quot;select ...&quot;</span><span class="p">);</span>
<span class="c1">//3、最后一定得用如下来执行整个任务，否则会报没有触发算子无法生成流图</span>
<span class="n">env</span><span class="p">.</span><span class="na">execute</span><span class="p">();</span>
</pre></div>
</div>
<blockquote>
<div><p>说明，如果你只想使用了流表，并且都是使用SQL进行操作，那么你可以使用1的方式进行操作，而不需要使用2和3。但是，如果将流和表混合使用，在触发任务执行的时候，将1、2、3结合使用仍然会抛出异常，这时候你得抛弃1的使用方法，而将2和3结合使用(使用Flink1.12版本进行测试)</p>
</div></blockquote>
</section>
<section id="id1">
<h4><span class="section-number">6.1.2.3. </span>一个问题：Hive怎么没数据？<a class="headerlink" href="#id1" title="永久链接至标题"></a></h4>
<ul class="simple">
<li><p>1、当你使用以上代码去往Hive写数据时，经过一番操作，发现任务跑起来了，并且没有抛异常(抛了也被你解决了)，一切执行成功，非常nice，可是你去查询hive的时候却发现，表里却没有数据，这时候再去hdfs上文件目录里也是有文件的，并且可以看到<code class="docutils literal notranslate"><span class="pre">inprogress</span></code></p>
<ul>
<li><p>解决办法：检查代码是否设置了checkpoint，如果设置了再检查程序是否checkpoint成功。Flink只有在checkpoint成功时才会将hive的分区信息commit并且输出的小文件由inprogress状态切换位success</p></li>
</ul>
</li>
<li><p>2、当发现1的问题后成功设置了checkpoint，但还是发现hive中没有数据</p>
<ul>
<li><p>这个时候当程序成功运行完之后，需要去Hive上修复目标表，修复表的元数据，即<code class="docutils literal notranslate"><span class="pre">MSCK</span> <span class="pre">REPAIR</span> <span class="pre">TABLE</span> <span class="pre">xxx.xxx</span></code></p></li>
</ul>
</li>
</ul>
</section>
</section>
</section>
<section id="kafka">
<h2><span class="section-number">6.2. </span>Kafka<a class="headerlink" href="#kafka" title="永久链接至标题"></a></h2>
<section id="read-from-kafka">
<h3><span class="section-number">6.2.1. </span>Read From Kafka<a class="headerlink" href="#read-from-kafka" title="永久链接至标题"></a></h3>
<section id="datastream-api">
<h4><span class="section-number">6.2.1.1. </span>使用DataStream API<a class="headerlink" href="#datastream-api" title="永久链接至标题"></a></h4>
<p>以下使用了SimpleStringSchema去反序列化kafka中的消息，如果遇到了flink提供的反序列化类不足以支撑实现你的业务功能时，需要自定义反序列化Schema，可以参考<a class="reference external" href="https://code-cookbook.readthedocs.io/zh_CN/main/Blog%20Here/%5BFlink%5D%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BA%8F%E5%88%97%E5%8C%96%E6%B6%88%E8%B4%B9Kafka%E6%95%B0%E6%8D%AE.html">前面文章</a>,描述了一个自定义Schema去反序列化Kafka中的存储着的序列化的对象的消息</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@SneakyThrows</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">QueryKafka</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">StreamExecutionEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="n">StreamExecutionEnvironment</span><span class="p">.</span><span class="na">getExecutionEnvironment</span><span class="p">();</span>

    <span class="n">Properties</span> <span class="n">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="p">();</span>
    <span class="n">properties</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="s">&quot;bootstrap.servers&quot;</span><span class="p">,</span> <span class="s">&quot;cdh001:9092,cdh002:9092,cdh003:9092&quot;</span><span class="p">);</span>
    <span class="n">properties</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="s">&quot;group.id&quot;</span><span class="p">,</span> <span class="s">&quot;test&quot;</span><span class="p">);</span>
    <span class="n">DataStream</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">env</span><span class="p">.</span><span class="na">addSource</span><span class="p">(</span>
            <span class="k">new</span> <span class="n">FlinkKafkaConsumer</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="s">&quot;mos-uat-vds-charging_settings_snapshot-vcf_originated&quot;</span><span class="p">,</span>
                    <span class="k">new</span> <span class="n">SimpleStringSchema</span><span class="p">(),</span> <span class="n">properties</span><span class="p">)</span>
            <span class="p">.</span><span class="na">setStartFromEarliest</span><span class="p">()</span>
    <span class="p">);</span>
    <span class="n">stream</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="k">new</span> <span class="n">MapFunction</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">map</span><span class="p">(</span><span class="n">String</span> <span class="n">value</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}).</span><span class="na">print</span><span class="p">();</span>

    <span class="n">env</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="s">&quot;Kafka Source&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="sink-to-kafka">
<h3><span class="section-number">6.2.2. </span>Sink to kafka<a class="headerlink" href="#sink-to-kafka" title="永久链接至标题"></a></h3>
<blockquote>
<div><p>以下来自于flink官网(版本1.12)</p>
</div></blockquote>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">DataStream</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">stream</span> <span class="o">=</span> <span class="p">...</span>

<span class="n">Properties</span> <span class="n">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="p">();</span>
<span class="n">properties</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="s">&quot;bootstrap.servers&quot;</span><span class="p">,</span> <span class="s">&quot;localhost:9092&quot;</span><span class="p">);</span>

<span class="n">FlinkKafkaProducer</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">myProducer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FlinkKafkaProducer</span><span class="o">&lt;&gt;</span><span class="p">(</span>
        <span class="s">&quot;my-topic&quot;</span><span class="p">,</span>                  <span class="c1">// target topic</span>
        <span class="k">new</span> <span class="n">SimpleStringSchema</span><span class="p">(),</span>    <span class="c1">// serialization schema</span>
        <span class="n">properties</span><span class="p">,</span>                  <span class="c1">// producer config</span>
        <span class="n">FlinkKafkaProducer</span><span class="p">.</span><span class="na">Semantic</span><span class="p">.</span><span class="na">EXACTLY_ONCE</span><span class="p">);</span> <span class="c1">// fault-tolerance</span>

<span class="n">stream</span><span class="p">.</span><span class="na">addSink</span><span class="p">(</span><span class="n">myProducer</span><span class="p">);</span>
</pre></div>
</div>
</section>
</section>
<section id="http">
<h2><span class="section-number">6.3. </span>HTTP<a class="headerlink" href="#http" title="永久链接至标题"></a></h2>
<p>以下为自定义的HttpSource用以获取http接口数据的核心代码，里面包含了一些复杂的业务代码(先在open方法中调用接口获取到token，再拿着token去run方法中调用接口获取数据)，经过删繁就简就进行简单替换即可实现自己的业务需求。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.xxxx.xxxx.source</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.core.JsonProcessingException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.databind.JsonNode</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.databind.ObjectMapper</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.xxxx.xxxx.utils.HttpUtils</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.SneakyThrows</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.configuration.Configuration</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.metrics.Counter</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.metrics.SimpleCounter</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.streaming.api.functions.source.RichSourceFunction</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Flink从接口获取数据</span>
<span class="cm"> *</span>
<span class="cm"> * @author roohom</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HttpSource</span> <span class="kd">extends</span> <span class="n">RichSourceFunction</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOG</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">HttpSource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">isRunning</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">getURL</span><span class="p">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">getSizeURL</span><span class="p">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">tokenPostURL</span><span class="p">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">postBody</span><span class="p">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">requestInterval</span><span class="p">;</span>

    <span class="c1">// count out event</span>
    <span class="kd">private</span> <span class="kd">transient</span> <span class="n">Counter</span> <span class="n">counter</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">HttpSource</span><span class="p">(</span><span class="n">String</span> <span class="n">getURL</span><span class="p">,</span> <span class="n">String</span> <span class="n">getSizeURL</span><span class="p">,</span> <span class="n">String</span> <span class="n">tokenPostURL</span><span class="p">,</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">postBody</span><span class="p">,</span> <span class="kt">long</span> <span class="n">requestInterval</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">getURL</span> <span class="o">=</span> <span class="n">getURL</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">getSizeURL</span> <span class="o">=</span> <span class="n">getSizeURL</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">tokenPostURL</span> <span class="o">=</span> <span class="n">tokenPostURL</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">postBody</span> <span class="o">=</span> <span class="n">postBody</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">requestInterval</span> <span class="o">=</span> <span class="n">requestInterval</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">String</span> <span class="n">token</span><span class="p">;</span>
    <span class="n">ObjectMapper</span> <span class="n">objectMapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectMapper</span><span class="p">();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">open</span><span class="p">(</span><span class="n">Configuration</span> <span class="n">parameters</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleCounter</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="na">counter</span> <span class="o">=</span> <span class="n">getRuntimeContext</span><span class="p">()</span>
                <span class="p">.</span><span class="na">getMetricGroup</span><span class="p">()</span>
                <span class="p">.</span><span class="na">counter</span><span class="p">(</span><span class="s">&quot;httpCounter&quot;</span><span class="p">);</span>
        <span class="c1">//获取TOKEN</span>
        <span class="n">String</span> <span class="n">tokenJson</span> <span class="o">=</span> <span class="n">HttpUtils</span><span class="p">.</span><span class="na">doPost</span><span class="p">(</span><span class="n">tokenPostURL</span><span class="p">,</span> <span class="n">postBody</span><span class="p">);</span>
        <span class="n">JsonNode</span> <span class="n">jsonNode</span> <span class="o">=</span> <span class="n">objectMapper</span><span class="p">.</span><span class="na">readTree</span><span class="p">(</span><span class="n">tokenJson</span><span class="p">);</span>
        <span class="n">JsonNode</span> <span class="n">accessToken</span> <span class="o">=</span> <span class="n">jsonNode</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;access_token&quot;</span><span class="p">);</span>
        <span class="n">JsonNode</span> <span class="n">tokenType</span> <span class="o">=</span> <span class="n">jsonNode</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;token_type&quot;</span><span class="p">);</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">tokenType</span><span class="p">.</span><span class="na">toString</span><span class="p">().</span><span class="na">replace</span><span class="p">(</span><span class="s">&quot;\&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">accessToken</span><span class="p">.</span><span class="na">toString</span><span class="p">().</span><span class="na">replaceAll</span><span class="p">(</span><span class="s">&quot;\&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">(</span><span class="n">SourceContext</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">ctx</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">totalSizeMsg</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">//获取全部数据的个数</span>
            <span class="n">totalSizeMsg</span> <span class="o">=</span> <span class="n">HttpUtils</span><span class="p">.</span><span class="na">doGet</span><span class="p">(</span><span class="n">getSizeURL</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
            <span class="n">JsonNode</span> <span class="n">sizeNode</span> <span class="o">=</span> <span class="n">objectMapper</span><span class="p">.</span><span class="na">readTree</span><span class="p">(</span><span class="n">totalSizeMsg</span><span class="p">);</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">sizeNode</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">).</span><span class="na">toString</span><span class="p">());</span>
            <span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;HttpSource -&gt; Get the size of all omd data -&gt; {}&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;HttpSource -&gt; Do get request failed.&quot;</span><span class="p">);</span>
            <span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="c1">//将消息切分，每一页20条</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">String</span> <span class="n">requestURL</span> <span class="o">=</span> <span class="n">getURL</span><span class="p">;</span>
            <span class="n">requestURL</span> <span class="o">+=</span> <span class="s">&quot;?pageNo=&quot;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">&quot;&amp;pageSize=20&quot;</span><span class="p">;</span>
            <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">HttpUtils</span><span class="p">.</span><span class="na">doGet</span><span class="p">(</span><span class="n">requestURL</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
            <span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;HttpSource -&gt; GET the url here, the url is -&gt; {}&quot;</span><span class="p">,</span> <span class="n">requestURL</span><span class="p">);</span>

            <span class="n">collectMessage</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">objectMapper</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
            <span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">requestInterval</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">cancel</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">isRunning</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 收集数据以发送</span>
<span class="cm">     *</span>
<span class="cm">     * @param ctx 流上下文</span>
<span class="cm">     */</span>
    <span class="nd">@SneakyThrows</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">collectMessage</span><span class="p">(</span><span class="n">SourceContext</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">ObjectMapper</span> <span class="n">objectMapper</span><span class="p">,</span> <span class="n">String</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">JsonNode</span> <span class="n">dataNodes</span> <span class="o">=</span> <span class="n">objectMapper</span><span class="p">.</span><span class="na">readTree</span><span class="p">(</span><span class="n">message</span><span class="p">).</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">dataList</span> <span class="o">=</span> <span class="n">objectMapper</span><span class="p">.</span><span class="na">readValue</span><span class="p">(</span><span class="n">dataNodes</span><span class="p">.</span><span class="na">toString</span><span class="p">(),</span> <span class="n">List</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">dataList</span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="p">{</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="n">ctx</span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">objectMapper</span><span class="p">.</span><span class="na">writeValueAsString</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
                <span class="k">this</span><span class="p">.</span><span class="na">counter</span><span class="p">.</span><span class="na">inc</span><span class="p">();</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">JsonProcessingException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>上面用到的HttpUtils如下：</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.xxxx.xxxx.utils</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">lombok.SneakyThrows</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.NameValuePair</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.client.config.RequestConfig</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.client.entity.UrlEncodedFormEntity</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.client.methods.CloseableHttpResponse</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.client.methods.HttpGet</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.client.methods.HttpPost</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.entity.StringEntity</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.impl.client.CloseableHttpClient</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.impl.client.HttpClients</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.message.BasicHeader</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.message.BasicNameValuePair</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.util.EntityUtils</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="p">;</span>


<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HttpUtils</span> <span class="p">{</span>


    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">HttpUtils</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

    <span class="cm">/**</span>
<span class="cm">     * 默认超时时间</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">DEFAULT_TIME_OUT</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * get请求，超时时间默认</span>
<span class="cm">     *</span>
<span class="cm">     * @param api 请求URL</span>
<span class="cm">     * @return 响应JSON字符串</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">doGet</span><span class="p">(</span><span class="n">String</span> <span class="n">api</span><span class="p">,</span> <span class="n">String</span> <span class="n">token</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">doGet</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">DEFAULT_TIME_OUT</span><span class="p">);</span>
    <span class="p">}</span>


    <span class="cm">/**</span>
<span class="cm">     * get请求，超时时间传参</span>
<span class="cm">     *</span>
<span class="cm">     * @param api     请求URL</span>
<span class="cm">     * @param timeOut 请求超时时间（毫秒）</span>
<span class="cm">     * @return 响应JSON字符串</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">doGet</span><span class="p">(</span><span class="n">String</span> <span class="n">api</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeOut</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HttpGet</span> <span class="n">httpGet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpGet</span><span class="p">(</span><span class="n">api</span><span class="p">);</span>
        <span class="n">RequestConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="n">RequestConfig</span><span class="p">.</span><span class="na">custom</span><span class="p">()</span>
                <span class="p">.</span><span class="na">setConnectTimeout</span><span class="p">(</span><span class="n">timeOut</span><span class="p">)</span>
                <span class="p">.</span><span class="na">setConnectionRequestTimeout</span><span class="p">(</span><span class="n">timeOut</span><span class="p">)</span>
                <span class="p">.</span><span class="na">build</span><span class="p">();</span>
        <span class="n">httpGet</span><span class="p">.</span><span class="na">setConfig</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>

        <span class="k">try</span> <span class="p">(</span><span class="n">CloseableHttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">HttpClients</span><span class="p">.</span><span class="na">createDefault</span><span class="p">();</span>
             <span class="n">CloseableHttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">httpGet</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">EntityUtils</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getEntity</span><span class="p">());</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;get &quot;</span> <span class="o">+</span> <span class="n">api</span> <span class="o">+</span> <span class="s">&quot; failed!&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * get请求，超时时间传参</span>
<span class="cm">     *</span>
<span class="cm">     * @param api     请求URL</span>
<span class="cm">     * @param token   token</span>
<span class="cm">     * @param timeOut 请求超时时间（毫秒）</span>
<span class="cm">     * @return 响应JSON字符串</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">doGet</span><span class="p">(</span><span class="n">String</span> <span class="n">api</span><span class="p">,</span> <span class="n">String</span> <span class="n">token</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeOut</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HttpGet</span> <span class="n">httpGet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpGet</span><span class="p">(</span><span class="n">api</span><span class="p">);</span>
        <span class="n">RequestConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="n">RequestConfig</span><span class="p">.</span><span class="na">custom</span><span class="p">()</span>
                <span class="p">.</span><span class="na">setConnectTimeout</span><span class="p">(</span><span class="n">timeOut</span><span class="p">)</span>
                <span class="p">.</span><span class="na">setConnectionRequestTimeout</span><span class="p">(</span><span class="n">timeOut</span><span class="p">)</span>
                <span class="p">.</span><span class="na">setAuthenticationEnabled</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
                <span class="p">.</span><span class="na">build</span><span class="p">();</span>

        <span class="n">httpGet</span><span class="p">.</span><span class="na">setConfig</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
        <span class="n">httpGet</span><span class="p">.</span><span class="na">addHeader</span><span class="p">(</span><span class="k">new</span> <span class="n">BasicHeader</span><span class="p">(</span><span class="s">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s">&quot;application/json&quot;</span><span class="p">));</span>
        <span class="n">httpGet</span><span class="p">.</span><span class="na">addHeader</span><span class="p">(</span><span class="k">new</span> <span class="n">BasicHeader</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">,</span> <span class="n">token</span><span class="p">));</span>

        <span class="k">try</span> <span class="p">(</span><span class="n">CloseableHttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">HttpClients</span><span class="p">.</span><span class="na">createDefault</span><span class="p">();</span>
             <span class="n">CloseableHttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">httpGet</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">EntityUtils</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getEntity</span><span class="p">());</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;get &quot;</span> <span class="o">+</span> <span class="n">api</span> <span class="o">+</span> <span class="s">&quot; failed!&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * post请求，超时时间默认</span>
<span class="cm">     *</span>
<span class="cm">     * @param api  请求URL</span>
<span class="cm">     * @param body 请求体JSON字符串</span>
<span class="cm">     * @return 响应JSON字符串</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">doPost</span><span class="p">(</span><span class="n">String</span> <span class="n">api</span><span class="p">,</span> <span class="n">String</span> <span class="n">body</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">doPost</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">DEFAULT_TIME_OUT</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * post请求，超时时间默认</span>
<span class="cm">     *</span>
<span class="cm">     * @param api  请求URL</span>
<span class="cm">     * @param body 请求体JSON字符串</span>
<span class="cm">     * @return 响应JSON字符串</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">doPost</span><span class="p">(</span><span class="n">String</span> <span class="n">api</span><span class="p">,</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">body</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">doPost</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">DEFAULT_TIME_OUT</span><span class="p">);</span>
    <span class="p">}</span>


    <span class="cm">/**</span>
<span class="cm">     * post请求，超时时间传参</span>
<span class="cm">     *</span>
<span class="cm">     * @param api     请求URL</span>
<span class="cm">     * @param body    请求体JSON字符串</span>
<span class="cm">     * @param timeOut 请求超时时间（毫秒）</span>
<span class="cm">     * @return 响应JSON字符串</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">doPost</span><span class="p">(</span><span class="n">String</span> <span class="n">api</span><span class="p">,</span> <span class="n">String</span> <span class="n">body</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeOut</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HttpPost</span> <span class="n">httpPost</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpPost</span><span class="p">(</span><span class="n">api</span><span class="p">);</span>
        <span class="n">StringEntity</span> <span class="n">entity</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringEntity</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="s">&quot;utf-8&quot;</span><span class="p">);</span>
        <span class="n">entity</span><span class="p">.</span><span class="na">setContentType</span><span class="p">(</span><span class="s">&quot;application/json&quot;</span><span class="p">);</span>
        <span class="n">entity</span><span class="p">.</span><span class="na">setContentEncoding</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">);</span>
        <span class="n">httpPost</span><span class="p">.</span><span class="na">setEntity</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
        <span class="n">RequestConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="n">RequestConfig</span><span class="p">.</span><span class="na">custom</span><span class="p">()</span>
                <span class="p">.</span><span class="na">setConnectTimeout</span><span class="p">(</span><span class="n">timeOut</span><span class="p">)</span>
                <span class="p">.</span><span class="na">setConnectionRequestTimeout</span><span class="p">(</span><span class="n">timeOut</span><span class="p">)</span>
                <span class="p">.</span><span class="na">build</span><span class="p">();</span>
        <span class="n">httpPost</span><span class="p">.</span><span class="na">setConfig</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>

        <span class="k">try</span> <span class="p">(</span><span class="n">CloseableHttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">HttpClients</span><span class="p">.</span><span class="na">createDefault</span><span class="p">();</span>
             <span class="n">CloseableHttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">httpPost</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">EntityUtils</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getEntity</span><span class="p">());</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;post &quot;</span> <span class="o">+</span> <span class="n">api</span> <span class="o">+</span> <span class="s">&quot; failed!&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * post请求，超时时间传参</span>
<span class="cm">     *</span>
<span class="cm">     * @param api     请求URL</span>
<span class="cm">     * @param body    请求体Map</span>
<span class="cm">     * @param timeOut 请求超时时间（毫秒）</span>
<span class="cm">     * @return 响应JSON字符串</span>
<span class="cm">     */</span>
    <span class="nd">@SneakyThrows</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">doPost</span><span class="p">(</span><span class="n">String</span> <span class="n">api</span><span class="p">,</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">body</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeOut</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HttpPost</span> <span class="n">httpPost</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpPost</span><span class="p">(</span><span class="n">api</span><span class="p">);</span>

        <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">NameValuePair</span><span class="o">&gt;</span> <span class="n">pairs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="n">body</span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span>
                <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pairs</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">BasicNameValuePair</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
        <span class="p">);</span>

        <span class="n">httpPost</span><span class="p">.</span><span class="na">setHeader</span><span class="p">(</span><span class="s">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s">&quot;application/x-www-form-urlencoded;charset=utf-8&quot;</span><span class="p">);</span>
        <span class="n">httpPost</span><span class="p">.</span><span class="na">setEntity</span><span class="p">(</span><span class="k">new</span> <span class="n">UrlEncodedFormEntity</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="s">&quot;UTF-8&quot;</span><span class="p">));</span>
        <span class="n">RequestConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="n">RequestConfig</span><span class="p">.</span><span class="na">custom</span><span class="p">()</span>
                <span class="p">.</span><span class="na">setConnectTimeout</span><span class="p">(</span><span class="n">timeOut</span><span class="p">)</span>
                <span class="p">.</span><span class="na">setConnectionRequestTimeout</span><span class="p">(</span><span class="n">timeOut</span><span class="p">)</span>
                <span class="p">.</span><span class="na">build</span><span class="p">();</span>
        <span class="n">httpPost</span><span class="p">.</span><span class="na">setConfig</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>

        <span class="k">try</span> <span class="p">(</span><span class="n">CloseableHttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">HttpClients</span><span class="p">.</span><span class="na">createDefault</span><span class="p">();</span>
             <span class="n">CloseableHttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">httpPost</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">EntityUtils</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getEntity</span><span class="p">());</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;post &quot;</span> <span class="o">+</span> <span class="n">api</span> <span class="o">+</span> <span class="s">&quot; failed!&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="%5BFlink%5DFlink-connector-http.html" class="btn btn-neutral float-left" title="5. [Flink]Flink-connector-http" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="%5BFlink%5DProcessFunction%E6%97%A0%E6%B3%95%E4%BD%BF%E7%94%A8%EF%BC%8C%E6%8A%9B%E5%87%BAInvalidProgramException.html" class="btn btn-neutral float-right" title="7. [Flink]ProcessFunction无法使用，抛出InvalidProgramException" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2020-2022, roohom.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>