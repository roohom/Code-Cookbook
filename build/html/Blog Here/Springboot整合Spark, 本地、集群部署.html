

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>24. Springboot整合Spark, 本地、集群部署 &mdash; Code-Cookbook 0.1 文档</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/translations.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="25. Vim查找和替换命令" href="Vim%E6%9F%A5%E6%89%BE%E5%92%8C%E6%9B%BF%E6%8D%A2%E5%91%BD%E4%BB%A4.html" />
    <link rel="prev" title="23. Spark提交任务RSA premaster secret error" href="Spark%E6%8F%90%E4%BA%A4%E4%BB%BB%E5%8A%A1RSA%20premaster%20secret%20error.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Code-Cookbook
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">大数据</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Bigdata/index.html">Bigdata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Bigdata%20Tools/index.html">Bigdata Tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">博客</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Blogs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="0904%E6%A8%A1%E6%8B%9F%E9%9D%A2%E8%AF%95%E9%A2%98%E6%95%B4%E7%90%86.html">1. 面试题整理</a></li>
<li class="toctree-l2"><a class="reference internal" href="1008%E6%A8%A1%E6%8B%9F%E9%9D%A2%E8%AF%95%E6%95%B4%E7%90%86.html">2. 实时存储NoSQL面试</a></li>
<li class="toctree-l2"><a class="reference internal" href="Annotation.html">3. 元注解</a></li>
<li class="toctree-l2"><a class="reference internal" href="Annotation.html#id2">4. 注解解析</a></li>
<li class="toctree-l2"><a class="reference internal" href="Closure%26Currying.html">5. Scala函数中闭包(Closure)和柯里化(Currying)</a></li>
<li class="toctree-l2"><a class="reference internal" href="Collection.html">6. 集合</a></li>
<li class="toctree-l2"><a class="reference internal" href="Collection.html#id9">7. 简单(常用)数据结构</a></li>
<li class="toctree-l2"><a class="reference internal" href="Commands.html">8. Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="EOF.html">9. EOF</a></li>
<li class="toctree-l2"><a class="reference internal" href="Git.html">10. Git问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="Hadoop%20distcp.html">11. Hadoop distcp</a></li>
<li class="toctree-l2"><a class="reference internal" href="Hive%20SQL50%E9%A2%98%E8%AE%B0%E5%BD%95.html">12. Hive SQL50题记录</a></li>
<li class="toctree-l2"><a class="reference internal" href="IO%E6%B5%81.html">13. <code class="docutils literal notranslate"><span class="pre">IO</span> <span class="pre">Stream</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="Java%20Cookbook.html">14. JAVA Cookbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="Java8%20Stream%28%29.html">15. Java8 Stream API</a></li>
<li class="toctree-l2"><a class="reference internal" href="Java_Maven.html">16. Maven</a></li>
<li class="toctree-l2"><a class="reference internal" href="Java_OOP.html">17. Java_OOP</a></li>
<li class="toctree-l2"><a class="reference internal" href="Java%E4%B8%ADSocket%E5%8F%91%E9%80%81%E6%96%87%E4%BB%B6%E8%87%B3%E6%9C%8D%E5%8A%A1%E7%AB%AF.html">18. 使用Java在服务端和客户端之间传送文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="PySpark.html">19. PySpark</a></li>
<li class="toctree-l2"><a class="reference internal" href="PySparkOnYarn.html">20. PySpark On Yarn</a></li>
<li class="toctree-l2"><a class="reference internal" href="SimpleDataStruct.html">21. 简单(常用)数据结构</a></li>
<li class="toctree-l2"><a class="reference internal" href="Socket.html">22. Socket</a></li>
<li class="toctree-l2"><a class="reference internal" href="Spark%E6%8F%90%E4%BA%A4%E4%BB%BB%E5%8A%A1RSA%20premaster%20secret%20error.html">23. Spark提交任务RSA premaster secret error</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">24. Springboot整合Spark, 本地、集群部署</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">24.1. 先决条件</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">24.2. 遇到的问题</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">24.2.1. 0、本地错误</a></li>
<li class="toctree-l4"><a class="reference internal" href="#log4j">24.2.2. 1、Log4j日志依赖冲突</a></li>
<li class="toctree-l4"><a class="reference internal" href="#loggercontext">24.2.3. 2、LoggerContext转换异常</a></li>
<li class="toctree-l4"><a class="reference internal" href="#gsonbuilder">24.2.4. 3、GsonBuilder异常</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hftpfilesystem">24.2.5. 4、HftpFileSystem异常</a></li>
<li class="toctree-l4"><a class="reference internal" href="#gson">24.2.6. 5、继续Gson异常</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id4">24.3. 总结</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">24.4. 参考和感谢</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">24.5. 附录</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pom-xml">24.5.1. 1、pom.xml</a></li>
<li class="toctree-l4"><a class="reference internal" href="#spark">24.5.2. 2、spark启动脚本</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="Vim%E6%9F%A5%E6%89%BE%E5%92%8C%E6%9B%BF%E6%8D%A2%E5%91%BD%E4%BB%A4.html">25. Vim查找和替换命令</a></li>
<li class="toctree-l2"><a class="reference internal" href="shell%E8%84%9A%E6%9C%AC%E6%97%A5%E6%9C%9F%E9%80%92%E5%A2%9E%28%E8%B5%B7%E6%AD%A2%E6%97%A5%E6%9C%9F%E5%86%85%E9%80%92%E5%A2%9E%29.html">26. Shell脚本日期递增(起止日期内递增)</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E5%85%B3%E4%BA%8EKudu%20Upsert%E5%88%97%E7%9A%84%E9%97%AE%E9%A2%98.html">27. 关于Kudu Upsert列的问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E5%85%B3%E4%BA%8EKudu%E5%88%97%E7%9A%84%E9%A1%BA%E5%BA%8F%E7%9A%84%E4%BF%AE%E6%94%B9.html">28. 关于Kudu列的顺序的修改</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E5%8F%AF%E8%83%BD%E6%9C%89%E7%94%A8%E7%9A%84%E5%AD%A6%E4%B9%A0%E9%93%BE%E6%8E%A5.html">29. 可能有用的学习链接</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E5%8F%AF%E8%83%BD%E6%9C%89%E7%94%A8%E7%9A%84%E5%AD%A6%E4%B9%A0%E9%93%BE%E6%8E%A5.html#hive-orc">30. Hive - ORC 文件存储格式</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E5%A4%9A%E7%BA%BF%E7%A8%8B.html">31. 多线程</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E5%B0%86Spark%20DataFrame%E4%B8%AD%E7%9A%84%E6%95%B0%E5%80%BC%E5%8F%96%E5%87%BA.html">32. 将Spark DataFrame中的数值取出</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E6%89%93%E5%8D%B0%E6%9C%AC%E6%9C%BAIP.html">33. 打印本机IP</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E6%9C%AC%E5%9C%B0%E8%BF%9E%E6%8E%A5%E9%9C%80%E8%A6%81Kerberos%E8%AE%A4%E8%AF%81%E7%9A%84Hive.html">34. 本地连接需要Kerberos认证的Hive</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9E%8B%E9%97%AE%E9%A2%98.html">35. 生产者消费者模型问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html">36. JAVA设计模式</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html#continuing">37. Continuing…</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%85%AD%E5%A4%A7%E5%8E%9F%E5%88%99.html">38. 设计模式六大原则</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E6%A2%B3%E7%90%86.html">39. 面向对象知识点梳理</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%90%84%E7%A7%8D%E5%85%B3%E7%B3%BB.html">40. Java OOP防脱发指南</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">大数据辅助工具</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Auxiliary%20tools/index.html">Auxiliary tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">SQL相关</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../SQL/index.html">SQL</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Code-Cookbook</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Blogs</a> &raquo;</li>
        
      <li><span class="section-number">24. </span>Springboot整合Spark, 本地、集群部署</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/Blog Here/Springboot整合Spark, 本地、集群部署.md.txt" rel="nofollow"> 查看页面源码</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="springbootspark">
<h1><span class="section-number">24. </span>Springboot整合Spark, 本地、集群部署<a class="headerlink" href="#springbootspark" title="永久链接至标题">¶</a></h1>
<blockquote>
<div><p>最近需要完善一个底层执行引擎为Spark的数仓项目，其功能宏观上看类似于<code class="docutils literal notranslate"><span class="pre">hive</span> <span class="pre">-f</span> </code>命令，让不懂java的但会写sql的人也能胜任数仓开发。项目使用Springboot2.4 和Spark2.4 ，代码为java完成，最终实现可以在本地、集群包括client模式和cluster模式来提交运行。这其中坑也不少，下面是对该探索过程的总结，主要探讨的是上线部署过程中遇到的种种问题以及解决方式。</p>
</div></blockquote>
<p>下面文字略显臃肿，默认设置了<code class="docutils literal notranslate"><span class="pre">verbose=true</span></code></p>
<div class="section" id="id1">
<h2><span class="section-number">24.1. </span>先决条件<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>当然是Springboot2.4，Spark2.4，在项目的<code class="docutils literal notranslate"><span class="pre">pom.xml</span></code>中添加好相关的依赖，主要有</p>
<ul class="simple">
<li><p>spring-boot-starter</p></li>
<li><p>spark-core</p></li>
<li><p>spark-sql</p></li>
<li><p>Spark-hive</p></li>
<li><p>org.codehaus.janino</p></li>
<li><p>Hadoop-client</p></li>
<li><p>hadoop-common</p></li>
<li><p>Hadoop-hdfs</p></li>
</ul>
<p>相关依赖可以详见附录部分</p>
<p><strong>说明</strong>：项目上集群环境是spark2.4 + hadoop3.0.0-cdh6.1.1+Hive2.1.0-cdh6.1.1</p>
</div>
<div class="section" id="id2">
<h2><span class="section-number">24.2. </span>遇到的问题<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<div class="section" id="id3">
<h3><span class="section-number">24.2.1. </span>0、本地错误<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h3>
<p>此处默认本地代码已经写好，并且可以在本地成功运行，如果如果集群环境是hadoop3.0.0，那么在本地的maven中需要导入hadoop3.0.0的依赖包，可能会在本地无法运行，主要报错表现为<code class="docutils literal notranslate"><span class="pre">Unrecognized</span> <span class="pre">Hadoop</span> <span class="pre">major</span> <span class="pre">version</span> <span class="pre">number:</span> <span class="pre">3.0.0-cdh6.1.1</span></code>或者<code class="docutils literal notranslate"><span class="pre">HIVE_STATS_JDBC_TIMEOUT</span></code></p>
<p>这是因为当你导入Spark的相关依赖包之后，spark2.x默认导入的是hadoop2.6.5的包，而为了适配集群环境，我们又显示地导入了hadoop3.0.0的依赖包，而Hive2.x版本不能加载hadoop版本号为3的hadoop(粗糙点这么说，仔细的原因没有研究过)，所以跑出了异常，<code class="docutils literal notranslate"><span class="pre">HIVE_STATS_JDBC_TIMEOUT</span></code>也大致如此，百度博客园上也有位兄弟说是spark-hive源码的问题，这里贴出地址：<a class="reference external" href="https://www.cnblogs.com/fbiswt/p/11798514.html">传送门</a></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Caused</span> <span class="n">by</span><span class="p">:</span> <span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">IllegalArgumentException</span><span class="p">:</span> <span class="n">Unrecognized</span> <span class="n">Hadoop</span> <span class="n">major</span> <span class="n">version</span> <span class="n">number</span><span class="p">:</span> <span class="mf">3.0.0</span><span class="o">-</span><span class="n">cdh6</span><span class="mf">.1.1</span>
	<span class="n">at</span> <span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">hadoop</span><span class="p">.</span><span class="na">hive</span><span class="p">.</span><span class="na">shims</span><span class="p">.</span><span class="na">ShimLoader</span><span class="p">.</span><span class="na">getMajorVersion</span><span class="p">(</span><span class="n">ShimLoader</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="mi">174</span><span class="p">)</span>
	<span class="n">at</span> <span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">hadoop</span><span class="p">.</span><span class="na">hive</span><span class="p">.</span><span class="na">shims</span><span class="p">.</span><span class="na">ShimLoader</span><span class="p">.</span><span class="na">loadShims</span><span class="p">(</span><span class="n">ShimLoader</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="mi">139</span><span class="p">)</span>
	<span class="n">at</span> <span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">hadoop</span><span class="p">.</span><span class="na">hive</span><span class="p">.</span><span class="na">shims</span><span class="p">.</span><span class="na">ShimLoader</span><span class="p">.</span><span class="na">getHadoopShims</span><span class="p">(</span><span class="n">ShimLoader</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="mi">100</span><span class="p">)</span>
	<span class="n">at</span> <span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">hadoop</span><span class="p">.</span><span class="na">hive</span><span class="p">.</span><span class="na">conf</span><span class="p">.</span><span class="na">HiveConf$ConfVars</span><span class="p">.</span><span class="o">&lt;</span><span class="n">clinit</span><span class="o">&gt;</span><span class="p">(</span><span class="n">HiveConf</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="mi">368</span><span class="p">)</span>
	<span class="p">...</span> <span class="mi">63</span> <span class="n">more</span>
</pre></div>
</div>
<p>如果你的代码在引入hadoop3.0.0去为了适配集群环境之前，就可以本地成功运行，那么在引入hadoop3.0.0依赖包之后，大胆地clean and package，毕竟人和代码有一个能跑就行了</p>
</div>
<div class="section" id="log4j">
<h3><span class="section-number">24.2.2. </span>1、Log4j日志依赖冲突<a class="headerlink" href="#log4j" title="永久链接至标题">¶</a></h3>
<p>当项目代码写好后，使用maven打包，将jar上传到服务器，使用spark-submit提交咱们的代码，当你满心期待控制台会一行行的汇报spark的运行状态从ACCEPT切换为RUNNING的时候，突然，报错了，大致抛出了以下异常，你开始满脸疑惑。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Exception</span> <span class="n">in</span> <span class="n">thread</span> <span class="s">&quot;main&quot;</span> <span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">IllegalArgumentException</span><span class="p">:</span> <span class="n">LoggerFactory</span> <span class="n">is</span> <span class="n">not</span> <span class="n">a</span> <span class="n">Logback</span> <span class="n">LoggerContext</span> <span class="n">but</span> <span class="n">Logback</span> <span class="n">is</span> <span class="n">on</span> <span class="n">the</span> <span class="n">classpath</span><span class="p">.</span> <span class="n">Either</span> <span class="n">remove</span> <span class="n">Logback</span> <span class="n">or</span> <span class="n">the</span> <span class="n">competing</span> <span class="n">implementation</span><span class="p">......</span>
</pre></div>
</div>
<p>于是你开始百度，突然你找到了一篇这样的博文，当然，我也看到了，<a class="reference external" href="https://blog.csdn.net/hz371071798/article/details/106221415">Maven项目同时包含Spark和Springboot时导致Log4j与Logback依赖冲突问题解决</a>,个人感觉这篇文章写得还是很好的，思路清晰，分析到位。</p>
<p>上面的报错信息大致是说，实际得到的LoggerContext不是一个Logback的，但是Logback却在类路径上要么将logback移除，要么自己实现xxx</p>
<p>啥？要改源码？那不可能，果断放弃！</p>
<p>于是我们选择将logback移除吧！</p>
<p>在移除之前我们来分析下为什么：</p>
<p><u>springboot默认使用logback来输出日志，而spark默认使用log4j来输出日志，并且，spark的日志输出是强制使用log4j的，所以两个日志系统并存之后产生了冲突，并且唯一选择是将logback排除，而使用log4j作为统一的输出工具。</u></p>
<p><strong>解决办法</strong>：在IDEA中使用maven-helper，搜索logback，挨个儿将其exclude掉，也就是使用exclusion标签排除掉。保险的是所有的日志相关都排除掉，然后手动引入log4j的依赖包。</p>
</div>
<div class="section" id="loggercontext">
<h3><span class="section-number">24.2.3. </span>2、LoggerContext转换异常<a class="headerlink" href="#loggercontext" title="永久链接至标题">¶</a></h3>
<p>你以为找到解决办法，把日志都排除手动引入log4j不就好了嘛，一切都搞定，clear and package，ok，丢包上服务器，spark-submit启动！于是又抛出了下面的异常：</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Caused</span> <span class="n">by</span><span class="p">:</span> <span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">ClassCastException</span><span class="p">:</span> <span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">logging</span><span class="p">.</span><span class="na">log4j</span><span class="p">.</span><span class="na">simple</span><span class="p">.</span><span class="na">SimpleLoggerContext</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">cast</span> <span class="n">to</span> <span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">logging</span><span class="p">.</span><span class="na">log4j</span><span class="p">.</span><span class="na">core</span><span class="p">.</span><span class="na">LoggerContext</span>
<span class="n">at</span> <span class="n">org</span><span class="p">.</span><span class="na">springframework</span><span class="p">.</span><span class="na">boot</span><span class="p">.</span><span class="na">logging</span><span class="p">.</span><span class="na">log4j2</span><span class="p">.</span><span class="na">Log4J2LoggingSystem</span><span class="p">.</span><span class="na">getLoggerContext</span><span class="p">(</span><span class="n">Log4J2LoggingSystem</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="mi">308</span><span class="p">)</span>
<span class="n">at</span> <span class="n">org</span><span class="p">.</span><span class="na">springframework</span><span class="p">.</span><span class="na">boot</span><span class="p">.</span><span class="na">logging</span><span class="p">.</span><span class="na">log4j2</span><span class="p">.</span><span class="na">Log4J2LoggingSystem</span><span class="p">.</span><span class="na">beforeInitialize</span><span class="p">(</span><span class="n">Log4J2LoggingSystem</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="mi">148</span><span class="p">)</span>
<span class="n">at</span> <span class="n">org</span><span class="p">.</span><span class="na">springframework</span><span class="p">.</span><span class="na">boot</span><span class="p">.</span><span class="na">context</span><span class="p">.</span><span class="na">logging</span><span class="p">.</span><span class="na">LoggingApplicationListener</span><span class="p">.</span><span class="na">onApplicationStartingEvent</span><span class="p">(</span><span class="n">LoggingApplicationListener</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="mi">232</span><span class="p">)</span>
<span class="n">at</span> <span class="n">org</span><span class="p">.</span><span class="na">springframework</span><span class="p">.</span><span class="na">boot</span><span class="p">.</span><span class="na">context</span><span class="p">.</span><span class="na">logging</span><span class="p">.</span><span class="na">LoggingApplicationListener</span><span class="p">.</span><span class="na">onApplicationEvent</span><span class="p">(</span><span class="n">LoggingApplicationListener</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="mi">213</span><span class="p">)</span>
<span class="p">......</span>
</pre></div>
</div>
<p>日志说得很清楚, <code class="docutils literal notranslate"><span class="pre">org.apache.logging.log4j.simple.SimpleLoggerContext</span></code>不能被转换为<code class="docutils literal notranslate"><span class="pre">org.apache.logging.log4j.core.LoggerContext</span></code>，一开始我以为是日志依赖包的问题，是不是哪里没有排除干净，检查了很久，参考了<a class="reference external" href="https://www.codeleading.com/article/8988997674/">SpringBoot + Spark on Yan踩坑记</a>之后设置springboot停止加载任何LoggerContext</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">driver</span><span class="o">-</span><span class="n">java</span><span class="o">-</span><span class="n">options</span> <span class="s">&quot;-Dorg.springframework.boot.logging.LoggingSystem=none&quot;</span>
</pre></div>
</div>
<p>对照着一想，spark以集群模式运行的时候，日志输出是在Driver节点上的，只要对Driver动手脚就可以了。</p>
</div>
<div class="section" id="gsonbuilder">
<h3><span class="section-number">24.2.4. </span>3、GsonBuilder异常<a class="headerlink" href="#gsonbuilder" title="永久链接至标题">¶</a></h3>
<p>上面日志转换的异常通过设置<code class="docutils literal notranslate"><span class="pre">driver-java-options</span></code>之后，解决了，但是新的问题又来了，真是一波未平一波又起，老天这是在捉弄我啊，抛了个下面的异常：</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>Caused by: org.springframework.beans.BeanInstantiationException: Failed to instantiate [com.google.gson.GsonBuilder]: Factory method &#39;gsonBuilder&#39; threw exception; nested exception is java.lang.BootstrapMethodError: java.lang.NoSuchMethodError: com.google.gson.GsonBuilder.setLenient()Lcom/google/gson/GsonBuilder;
at org.springframework.beans.factory.support.SimpleInstantiationStrategy.instantiate(SimpleInstantiationStrategy.java:185)
at org.springframework.beans.factory.support.ConstructorResolver.instantiate(ConstructorResolver.java:651)
... 24 more
</pre></div>
</div>
<p>日志说得很清楚，不能实例化一个GsonBuilder，冷静分析一波，不能实例化一个，怎么会？去看看maven，通过maven-helper一搜，在的啊，已经被自动引入了，难道说是依赖又冲突了？可是maven-helper并没有显示其冲突了，随着这个猜测，又手动将所有依赖gson的地方都排除，而手动引入，OK，打包上集群，跑起来，仍然报错，经过我的尝试，</p>
<ul class="simple">
<li><p>不引入该依赖，报同样的错</p></li>
<li><p>排除所有该依赖再手动引入，报同样的错</p></li>
<li><p>百度之后说换低版本(2.6.2)的gson(spark2.4和springboot2.4默认引入的是gson2.8.6)可以解决，换之，报同样的错</p></li>
<li><p>将所有依赖包打包成一个fat jar，该jar足足有157MB，这个时候，报错变了！</p></li>
</ul>
<p>怎么会呢，我在IDEA中搜索了<code class="docutils literal notranslate"><span class="pre">com.google.gson.GsonBuilder.setLenient()</span></code>,显示在2.8.6版本的源码中明明就有这个方法！</p>
<p><img alt="image-20210725013333715" src="../_images/image-20210725013333715.png" /></p>
<p>此问题悬而未决，继续看下面的分析。</p>
</div>
<div class="section" id="hftpfilesystem">
<h3><span class="section-number">24.2.5. </span>4、HftpFileSystem异常<a class="headerlink" href="#hftpfilesystem" title="永久链接至标题">¶</a></h3>
<p>打成所有依赖包在内的fat jar之后，一提交任务，还没有等到yarn汇报状态位ACCEPT的时候，就抛出了异常，如下：</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">IllegalAccessError</span><span class="p">:</span> <span class="kd">class</span> <span class="nc">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">hadoop</span><span class="p">.</span><span class="na">hdfs</span><span class="p">.</span><span class="na">web</span><span class="p">.</span><span class="na">HftpFileSystem</span> <span class="n">cannot</span> <span class="n">access</span> <span class="n">its</span> <span class="n">superinterface</span> <span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">hadoop</span><span class="p">.</span><span class="na">hdfs</span><span class="p">.</span><span class="na">web</span><span class="p">.</span><span class="na">TokenAspect$TokenManagementDelegator</span>
</pre></div>
</div>
<p>这啥玩意？本地都可以抛，为什么打包上集群就给我报这个错？</p>
<p>是我的错吗？是我不该写代码吗？</p>
<p>静下心来，想了一下，这种问题肯定都是依赖包问题，我不甘心，我继续尝试，一定是打包之后的依赖包与集群环境的依赖包存在冲突，于是抛弃使用这种方法。</p>
</div>
<div class="section" id="gson">
<h3><span class="section-number">24.2.6. </span>5、继续Gson异常<a class="headerlink" href="#gson" title="永久链接至标题">¶</a></h3>
<p>上面提到的踩坑记里面说到，<u>将Spark自带的GSON库重命名</u>，于是我去试了试，仍然报错！仍然无法实例化一个GsonBuilder，我突然想到，将部署模式切换为client模式，日志是不是好管理呢，于是我将spark-submit的部署模式设置为client重新跑了一遍，好家伙！日志变了，控制台开始打印出那个大大的Sprintboot的Banner了！Yarn也开始汇报状态位ACCEPT了！Nice！</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  .   ____          _            __ _ _
 /\\ / ___&#39;_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | &#39;_ | &#39;_| | &#39;_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  &#39;  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::
</pre></div>
</div>
<p>跑着跑着，并没有运行成功，不过下面倒是出现了这样的日志：</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">Error starting ApplicationContext. To display the conditions report re-run your application with &#39;debug&#39; enabled.</span>
<span class="na">21/07/22 23:19:54 ERROR diagnostics.LoggingFailureAnalysisReporter: </span>

<span class="na">***************************</span>
<span class="na">APPLICATION FAILED TO START</span>
<span class="na">***************************</span>

<span class="na">Description:</span>
<span class="na">An attempt was made to call a method that does not exist. The attempt was made from the following location:</span>
    <span class="na">java.lang.invoke.MethodHandleNatives.resolve(Native Method)</span>
<span class="na">The following method did not exist:</span>
    <span class="na">com.google.gson.GsonBuilder.setLenient()Lcom/google/gson/GsonBuilder;</span>
<span class="na">The method&#39;s class, com.google.gson.GsonBuilder, is available from the following locations:</span>
    <span class="na">jar:file:/opt/cloudera/parcels/CDH-6.1.1-1.cdh6.1.1.p0.875250/jars/gson-2.2.4.jar!/com/google/gson/GsonBuilder.class</span>
<span class="na">The class hierarchy was loaded from the following locations:</span>
    <span class="na">com.google.gson.GsonBuilder: file:/opt/cloudera/parcels/CDH-6.1.1-1.cdh6.1.1.p0.875250/jars/gson-2.2.4.jar</span>

<span class="na">Action:</span>
<span class="na">Correct the classpath of your application so that it contains a single, compatible version of com.google.gson.GsonBuilder</span>
</pre></div>
</div>
<p>日志中说得很明白，<code class="docutils literal notranslate"><span class="pre">com.google.gson.GsonBuilder.setLenient()Lcom/google/gson/GsonBuilder</span></code>这个方法不存在，但是这个方法的class从这个路径可以获取到<code class="docutils literal notranslate"><span class="pre">jar:file:/opt/cloudera/parcels/CDH-6.1.1-1.cdh6.1.1.p0.875250/jars/gson-2.2.4.jar!/com/google/gson/GsonBuilder.class</span></code></p>
<p>类的层级是从下面的路径中加载的：<code class="docutils literal notranslate"><span class="pre">com.google.gson.GsonBuilder:</span> <span class="pre">file:/opt/cloudera/parcels/CDH-6.1.1-1.cdh6.1.1.p0.875250/jars/gson-2.2.4.jar</span></code>， <strong>这说明项目实际加载的是版本为2.2.4的Gson，而没有加载版本为2.8.6的Gson</strong>。奇了怪了！我已经在第5异常中将spark底层自带的Gson库jiar包重命名了，这个从哪来的！于是我去找了其他地方也没找到！</p>
<p>于是我又去上面提到的踩坑记里面看了看，想着是不是项目在集群环境运行的时候加载错了依赖包或者有其默认的加载方式，而这正好冲突了。</p>
<p>我在spark-submit的参数中的<code class="docutils literal notranslate"><span class="pre">--driver-java-options</span></code>中继续添加了参数，使项目能够找到足够的依赖包，并且指定我所想要项目使用的jar包，在这里我手动指定gson的jar包为集群机器上有的版本为2.8.1的gson-2.8.1.jar，具体参数为：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>--driver-java-options <span class="s2">&quot;-Dorg.springframework.boot.logging.LoggingSystem=none -Djava.ext.dirs=/opt/cloudera/parcels/CDH-6.1.1-1.cdh6.1.1.p0.875250/lib/spark/jars/gson-2.8.1.jar,/opt/cloudera/parcels/CDH-6.1.1-1.cdh6.1.1.p0.875250/lib/hive/lib/* -Dspark.yarn.dist.files=/opt/cloudera/parcels/CDH-6.1.1-1.cdh6.1.1.p0.875250/etc/hadoop/conf.dist/yarn-site.xml&quot;</span> <span class="se">\</span>
--driver-class-path <span class="s2">&quot;/opt/cloudera/parcels/CDH-6.1.1-1.cdh6.1.1.p0.875250/jars/gson-2.8.1.jar&quot;</span> <span class="se">\</span>
</pre></div>
</div>
<p>当我使用了这些参数之后，好家伙！<strong>跑起来了</strong>！</p>
<p>这些参数和jar包是经过我尝试的出来的，已经足够运行，当然在不同的集群上需要替换为不同的目录，可能依赖包也不同，需要一定的调试。</p>
<p>现在不光是人能跑，代码也能跑了！</p>
<p><img alt="image-20210725012814350" src="../_images/image-20210725012814350.png" /></p>
<p>Driver的控制台输出：</p>
<p><img alt="image-20210725013138827" src="../_images/image-20210725013138827.png" /></p>
<p>日志打印输出：</p>
<p><img alt="image-20210725013227880" src="../_images/image-20210725013227880.png" /></p>
<p>成功创建了表，并且在表里写入了数据：</p>
<p><img alt="iShot2021-07-25 01.44.20" src="../_images/iShot2021-07-25-01.44.20.png" /></p>
</div>
</div>
<div class="section" id="id4">
<h2><span class="section-number">24.3. </span>总结<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p>本地代码可以运行成功，那么后面的大部分问题都是依赖包问题，这是一个复杂的过程，需要不断去调试</p></li>
<li><p>分析错误一定要有推断，根据现象去推断，适当的时候需要去看源码</p></li>
<li><p>看日志尤其重要！</p></li>
<li><p>新学习了一个单词：hierarchy，日志的意思应该是首先的意思，该包具有统治地位，那么就是首先嘛！</p></li>
</ul>
<p><img alt="image-20210725013821330" src="../_images/image-20210725013821330.png" /></p>
</div>
<div class="section" id="id5">
<h2><span class="section-number">24.4. </span>参考和感谢<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://www.codeleading.com/article/8988997674/">SpringBoot + Spark on Yan踩坑记</a></p></li>
<li><p><a class="reference external" href="https://blog.csdn.net/lyd882/article/details/103806085">Spark任务提交与SpringBoot项目集成</a></p></li>
</ul>
</div>
<div class="section" id="id6">
<h2><span class="section-number">24.5. </span>附录<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h2>
<div class="section" id="pom-xml">
<h3><span class="section-number">24.5.1. </span>1、pom.xml<a class="headerlink" href="#pom-xml" title="永久链接至标题">¶</a></h3>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>
         <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;groupId&gt;</span>com.svw<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>dw-spark-etl<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;properties&gt;</span>
        <span class="nt">&lt;spark.version&gt;</span>2.4.0<span class="nt">&lt;/spark.version&gt;</span>
        <span class="nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.build.sourceEncoding&gt;</span>
        <span class="nt">&lt;maven.compiler.source&gt;</span>1.8<span class="nt">&lt;/maven.compiler.source&gt;</span>
        <span class="nt">&lt;maven.compiler.target&gt;</span>1.8<span class="nt">&lt;/maven.compiler.target&gt;</span>
        <span class="nt">&lt;scala.version&gt;</span>2.11<span class="nt">&lt;/scala.version&gt;</span>
        <span class="nt">&lt;hive.version&gt;</span>2.1.1-cdh6.1.1<span class="nt">&lt;/hive.version&gt;</span>
        <span class="nt">&lt;hadoop.version&gt;</span>3.0.0-cdh6.1.1<span class="nt">&lt;/hadoop.version&gt;</span>
    <span class="nt">&lt;/properties&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-parent<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.4.0<span class="nt">&lt;/version&gt;</span>
        <span class="c">&lt;!--        &lt;relativePath&gt;/&lt;/relativePath&gt;--&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>

    <span class="nt">&lt;pluginRepositories&gt;</span>
        <span class="nt">&lt;pluginRepository&gt;</span>
            <span class="nt">&lt;id&gt;</span>alimaven spring plugin<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;name&gt;</span>alimaven spring plugin<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;url&gt;</span>https://maven.aliyun.com/repository/spring-plugin<span class="nt">&lt;/url&gt;</span>
        <span class="nt">&lt;/pluginRepository&gt;</span>

    <span class="nt">&lt;/pluginRepositories&gt;</span>
    <span class="nt">&lt;repositories&gt;</span>
        <span class="nt">&lt;repository&gt;</span>
            <span class="nt">&lt;id&gt;</span>cloudera<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;url&gt;</span>https://repository.cloudera.com/artifactory/cloudera-repos/<span class="nt">&lt;/url&gt;</span>
        <span class="nt">&lt;/repository&gt;</span>
    <span class="nt">&lt;/repositories&gt;</span>


    <span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;exclusions&gt;</span>
                <span class="nt">&lt;exclusion&gt;</span>
                    <span class="nt">&lt;artifactId&gt;</span>logback-core<span class="nt">&lt;/artifactId&gt;</span>
                    <span class="nt">&lt;groupId&gt;</span>ch.qos.logback<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;/exclusion&gt;</span>
                <span class="nt">&lt;exclusion&gt;</span>
                    <span class="nt">&lt;artifactId&gt;</span>logback-classic<span class="nt">&lt;/artifactId&gt;</span>
                    <span class="nt">&lt;groupId&gt;</span>ch.qos.logback<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;/exclusion&gt;</span>
                <span class="nt">&lt;exclusion&gt;</span>
                    <span class="nt">&lt;artifactId&gt;</span>log4j-to-slf4j<span class="nt">&lt;/artifactId&gt;</span>
                    <span class="nt">&lt;groupId&gt;</span>org.apache.logging.log4j<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;/exclusion&gt;</span>
                <span class="nt">&lt;exclusion&gt;</span>
                    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
                    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-logging<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;/exclusion&gt;</span>
                <span class="nt">&lt;exclusion&gt;</span>
                    <span class="nt">&lt;artifactId&gt;</span>gson<span class="nt">&lt;/artifactId&gt;</span>
                    <span class="nt">&lt;groupId&gt;</span>com.google.code.gson<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;/exclusion&gt;</span>
            <span class="nt">&lt;/exclusions&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.spark<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spark-core_2.11<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${spark.version}<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
            <span class="nt">&lt;exclusions&gt;</span>
                <span class="nt">&lt;exclusion&gt;</span>
                    <span class="nt">&lt;groupId&gt;</span>org.slf4j<span class="nt">&lt;/groupId&gt;</span>
                    <span class="nt">&lt;artifactId&gt;</span>slf4j-log4j12<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;/exclusion&gt;</span>
                <span class="nt">&lt;exclusion&gt;</span>
                    <span class="nt">&lt;groupId&gt;</span>log4j<span class="nt">&lt;/groupId&gt;</span>
                    <span class="nt">&lt;artifactId&gt;</span>log4j<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;/exclusion&gt;</span>
                <span class="nt">&lt;exclusion&gt;</span>
                    <span class="nt">&lt;artifactId&gt;</span>log4j-to-slf4j<span class="nt">&lt;/artifactId&gt;</span>
                    <span class="nt">&lt;groupId&gt;</span>org.apache.logging.log4j<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;/exclusion&gt;</span>
                <span class="nt">&lt;exclusion&gt;</span>
                    <span class="nt">&lt;artifactId&gt;</span>gson<span class="nt">&lt;/artifactId&gt;</span>
                    <span class="nt">&lt;groupId&gt;</span>com.google.code.gson<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;/exclusion&gt;</span>
                <span class="nt">&lt;exclusion&gt;</span>
                    <span class="nt">&lt;groupId&gt;</span>org.apache.hadoop<span class="nt">&lt;/groupId&gt;</span>
                    <span class="nt">&lt;artifactId&gt;</span>hadoop-client<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;/exclusion&gt;</span>
                <span class="nt">&lt;exclusion&gt;</span>
                    <span class="nt">&lt;groupId&gt;</span>org.apache.hadoop<span class="nt">&lt;/groupId&gt;</span>
                    <span class="nt">&lt;artifactId&gt;</span>hadoop-hdfs<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;/exclusion&gt;</span>
                <span class="nt">&lt;exclusion&gt;</span>
                    <span class="nt">&lt;artifactId&gt;</span>jackson-core-asl<span class="nt">&lt;/artifactId&gt;</span>
                    <span class="nt">&lt;groupId&gt;</span>org.codehaus.jackson<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;/exclusion&gt;</span>
            <span class="nt">&lt;/exclusions&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--显式引入log4j--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.slf4j<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>log4j-over-slf4j<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.7.31<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.google.code.gson<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>gson<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>2.8.6<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.slf4j<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>slf4j-api<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.7.31<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.slf4j<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>slf4j-simple<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.7.31<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.google.code.gson<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>gson<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>2.8.1<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.spark<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spark-sql_2.11<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${spark.version}<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.spark<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spark-hive_2.11<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${spark.version}<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
            <span class="nt">&lt;exclusions&gt;</span>
                <span class="nt">&lt;exclusion&gt;</span>
                    <span class="nt">&lt;artifactId&gt;</span>apache-log4j-extras<span class="nt">&lt;/artifactId&gt;</span>
                    <span class="nt">&lt;groupId&gt;</span>log4j<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;/exclusion&gt;</span>
                <span class="nt">&lt;exclusion&gt;</span>
                    <span class="nt">&lt;artifactId&gt;</span>jackson-mapper-asl<span class="nt">&lt;/artifactId&gt;</span>
                    <span class="nt">&lt;groupId&gt;</span>org.codehaus.jackson<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;/exclusion&gt;</span>
            <span class="nt">&lt;/exclusions&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.codehaus.janino<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>janino<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>3.0.8<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.commons<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>commons-lang3<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>3.11<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>junit<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>junit<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>4.11<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.18.10<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.dataformat<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>jackson-dataformat-yaml<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>2.10.2<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.hadoop<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>hadoop-client<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${hadoop.version}<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.hadoop<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>hadoop-hdfs<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${hadoop.version}<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.hadoop<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>hadoop-common<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${hadoop.version}<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
            <span class="nt">&lt;exclusions&gt;</span>
                <span class="nt">&lt;exclusion&gt;</span>
                    <span class="nt">&lt;artifactId&gt;</span>gson<span class="nt">&lt;/artifactId&gt;</span>
                    <span class="nt">&lt;groupId&gt;</span>com.google.code.gson<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;/exclusion&gt;</span>
            <span class="nt">&lt;/exclusions&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>commons-cli<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>commons-cli<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.4<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

    <span class="nt">&lt;/dependencies&gt;</span>

    <span class="nt">&lt;build&gt;</span>
        <span class="nt">&lt;resources&gt;</span>
            <span class="nt">&lt;resource&gt;</span>
                <span class="nt">&lt;directory&gt;</span>src/main/java<span class="nt">&lt;/directory&gt;</span>
                <span class="nt">&lt;includes&gt;</span>
                    <span class="nt">&lt;include&gt;</span>**/*.yml<span class="nt">&lt;/include&gt;</span>
                    <span class="nt">&lt;include&gt;</span>**/*.sql<span class="nt">&lt;/include&gt;</span>
                <span class="nt">&lt;/includes&gt;</span>
            <span class="nt">&lt;/resource&gt;</span>
            <span class="nt">&lt;resource&gt;</span>
                <span class="nt">&lt;directory&gt;</span>src/main/resources<span class="nt">&lt;/directory&gt;</span>
                <span class="nt">&lt;includes&gt;</span>
                    <span class="nt">&lt;include&gt;</span>**/*.yml<span class="nt">&lt;/include&gt;</span>
                    <span class="nt">&lt;include&gt;</span>**/*.sql<span class="nt">&lt;/include&gt;</span>
                <span class="nt">&lt;/includes&gt;</span>
            <span class="nt">&lt;/resource&gt;</span>
        <span class="nt">&lt;/resources&gt;</span>

        <span class="nt">&lt;plugins&gt;</span>
            <span class="nt">&lt;plugin&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>maven-assembly-plugin<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>2.5.5<span class="nt">&lt;/version&gt;</span>
                <span class="nt">&lt;configuration&gt;</span>
                    <span class="nt">&lt;archive&gt;</span>
                        <span class="nt">&lt;manifest&gt;</span>
                            <span class="nt">&lt;mainClass&gt;</span>com.csvw.dwsparketl.DwEtlApplication<span class="nt">&lt;/mainClass&gt;</span>
                        <span class="nt">&lt;/manifest&gt;</span>
                    <span class="nt">&lt;/archive&gt;</span>
                    <span class="nt">&lt;finalName&gt;</span>${project.artifactId}-${project.version}<span class="nt">&lt;/finalName&gt;</span>
                    <span class="nt">&lt;appendAssemblyId&gt;</span>false<span class="nt">&lt;/appendAssemblyId&gt;</span>
                    <span class="nt">&lt;descriptors&gt;</span>
                        <span class="nt">&lt;descriptor&gt;</span>src/main/assembly/release.xml<span class="nt">&lt;/descriptor&gt;</span>
                    <span class="nt">&lt;/descriptors&gt;</span>
                <span class="nt">&lt;/configuration&gt;</span>
                <span class="nt">&lt;executions&gt;</span>
                    <span class="nt">&lt;execution&gt;</span>
                        <span class="nt">&lt;id&gt;</span>make-assembly<span class="nt">&lt;/id&gt;</span>
                        <span class="nt">&lt;phase&gt;</span>package<span class="nt">&lt;/phase&gt;</span>
                        <span class="nt">&lt;goals&gt;</span>
                            <span class="nt">&lt;goal&gt;</span>single<span class="nt">&lt;/goal&gt;</span>
                        <span class="nt">&lt;/goals&gt;</span>
                    <span class="nt">&lt;/execution&gt;</span>
                <span class="nt">&lt;/executions&gt;</span>
            <span class="nt">&lt;/plugin&gt;</span>

            <span class="nt">&lt;plugin&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>maven-shade-plugin<span class="nt">&lt;/artifactId&gt;</span>
                <span class="c">&lt;!--                &lt;version&gt;3.1.1&lt;/version&gt;--&gt;</span>
                <span class="nt">&lt;executions&gt;</span>
                    <span class="nt">&lt;execution&gt;</span>
                        <span class="nt">&lt;phase&gt;</span>package<span class="nt">&lt;/phase&gt;</span>
                        <span class="nt">&lt;goals&gt;</span>
                            <span class="nt">&lt;goal&gt;</span>shade<span class="nt">&lt;/goal&gt;</span>
                        <span class="nt">&lt;/goals&gt;</span>
                        <span class="nt">&lt;configuration&gt;</span>
                            <span class="nt">&lt;keepDependenciesWithProvidedScope&gt;</span>false<span class="nt">&lt;/keepDependenciesWithProvidedScope&gt;</span>
                            <span class="nt">&lt;createDependencyReducedPom&gt;</span>false<span class="nt">&lt;/createDependencyReducedPom&gt;</span>
                            <span class="nt">&lt;filters&gt;</span>
                                <span class="nt">&lt;filter&gt;</span>
                                    <span class="nt">&lt;artifact&gt;</span>*:*<span class="nt">&lt;/artifact&gt;</span>
                                    <span class="nt">&lt;excludes&gt;</span>
                                        <span class="nt">&lt;exclude&gt;</span>META-INF/*.SF<span class="nt">&lt;/exclude&gt;</span>
                                        <span class="nt">&lt;exclude&gt;</span>META-INF/*.DSA<span class="nt">&lt;/exclude&gt;</span>
                                        <span class="nt">&lt;exclude&gt;</span>META-INF/*.RSA<span class="nt">&lt;/exclude&gt;</span>
                                    <span class="nt">&lt;/excludes&gt;</span>
                                <span class="nt">&lt;/filter&gt;</span>
                            <span class="nt">&lt;/filters&gt;</span>
                            <span class="nt">&lt;transformers&gt;</span>
                                <span class="nt">&lt;transformer</span>
                                        <span class="na">implementation=</span><span class="s">&quot;org.apache.maven.plugins.shade.resource.AppendingTransformer&quot;</span><span class="nt">&gt;</span>
                                    <span class="nt">&lt;resource&gt;</span>META-INF/spring.handlers<span class="nt">&lt;/resource&gt;</span>
                                <span class="nt">&lt;/transformer&gt;</span>
                                <span class="nt">&lt;transformer</span>
                                        <span class="na">implementation=</span><span class="s">&quot;org.springframework.boot.maven.PropertiesMergingResourceTransformer&quot;</span><span class="nt">&gt;</span>
                                    <span class="nt">&lt;resource&gt;</span>META-INF/spring.factories<span class="nt">&lt;/resource&gt;</span>
                                <span class="nt">&lt;/transformer&gt;</span>
                                <span class="nt">&lt;transformer</span>
                                        <span class="na">implementation=</span><span class="s">&quot;org.apache.maven.plugins.shade.resource.AppendingTransformer&quot;</span><span class="nt">&gt;</span>
                                    <span class="nt">&lt;resource&gt;</span>META-INF/spring.schemas<span class="nt">&lt;/resource&gt;</span>
                                <span class="nt">&lt;/transformer&gt;</span>
                                <span class="nt">&lt;transformer</span>
                                        <span class="na">implementation=</span><span class="s">&quot;org.apache.maven.plugins.shade.resource.ServicesResourceTransformer&quot;</span><span class="nt">/&gt;</span>
                                <span class="nt">&lt;transformer</span>
                                        <span class="na">implementation=</span><span class="s">&quot;org.apache.maven.plugins.shade.resource.ManifestResourceTransformer&quot;</span><span class="nt">&gt;</span>
                                    <span class="nt">&lt;mainClass&gt;</span>com.csvw.dwsparketl.DwEtlApplication<span class="nt">&lt;/mainClass&gt;</span>
                                <span class="nt">&lt;/transformer&gt;</span>
                            <span class="nt">&lt;/transformers&gt;</span>
                        <span class="nt">&lt;/configuration&gt;</span>
                    <span class="nt">&lt;/execution&gt;</span>
                <span class="nt">&lt;/executions&gt;</span>
            <span class="nt">&lt;/plugin&gt;</span>
        <span class="nt">&lt;/plugins&gt;</span>
    <span class="nt">&lt;/build&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="spark">
<h3><span class="section-number">24.5.2. </span>2、spark启动脚本<a class="headerlink" href="#spark" title="永久链接至标题">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>spark-submit <span class="se">\</span>
--master yarn <span class="se">\</span>
--deploy-mode cluster <span class="se">\</span>
--driver-java-options <span class="s2">&quot;-Dorg.springframework.boot.logging.LoggingSystem=none -Djava.ext.dirs=/opt/cloudera/parcels/CDH-6.1.1-1.cdh6.1.1.p0.875250/lib/spark/jars/gson-2.8.1.jar,/opt/cloudera/parcels/CDH-6.1.1-1.cdh6.1.1.p0.875250/lib/hive/lib/* -Dspark.yarn.dist.files=/opt/cloudera/parcels/CDH-6.1.1-1.cdh6.1.1.p0.875250/etc/hadoop/conf.dist/yarn-site.xml&quot;</span> <span class="se">\</span>
--driver-class-path <span class="s2">&quot;/opt/cloudera/parcels/CDH-6.1.1-1.cdh6.1.1.p0.875250/jars/gson-2.8.1.jar&quot;</span> <span class="se">\</span>
--driver-cores <span class="m">2</span> <span class="se">\</span>
--driver-memory 2G <span class="se">\</span>
--num-executors <span class="m">2</span> <span class="se">\</span>
--executor-cores <span class="m">2</span> <span class="se">\</span>
--executor-memory 2G <span class="se">\</span>
--conf spark.dynamicAllocation.enabled<span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
--conf spark.yarn.maxAppAttempts<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
--name <span class="nv">$name</span> <span class="se">\</span>
./dw-spark-etl-1.0-SNAPSHOT.jar 
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="Vim%E6%9F%A5%E6%89%BE%E5%92%8C%E6%9B%BF%E6%8D%A2%E5%91%BD%E4%BB%A4.html" class="btn btn-neutral float-right" title="25. Vim查找和替换命令" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="Spark%E6%8F%90%E4%BA%A4%E4%BB%BB%E5%8A%A1RSA%20premaster%20secret%20error.html" class="btn btn-neutral float-left" title="23. Spark提交任务RSA premaster secret error" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; 版权所有 2020-2021, roohom.

    </p>
  </div>
    
    
    
    利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    
    由 <a href="https://readthedocs.org">Read the Docs</a>开发. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>